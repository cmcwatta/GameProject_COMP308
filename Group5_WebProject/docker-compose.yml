services:
  # MongoDB Database
  mongodb:
    image: mongo:6.0
    container_name: gamification_mongodb
    ports:
      - "27017:27017"
    environment:
      MONGO_INITDB_ROOT_USERNAME: admin
      MONGO_INITDB_ROOT_PASSWORD: mongodb_password
      MONGO_INITDB_DATABASE: gamification_db
    volumes:
      - mongo_data:/data/db
      - mongo_config:/data/configdb
    healthcheck:
      test: echo 'db.runCommand("ping").ok' | mongosh localhost:27017/test --quiet
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - gamification_network

  # Authentication Service
  auth-service:
    build:
      context: ./Web_Backend/auth-service
      dockerfile: Dockerfile
    container_name: auth_service
    ports:
      - "4001:4001"
    environment:
      NODE_ENV: development
      PORT: 4001
      MONGODB_URI: mongodb://admin:mongodb_password@mongodb:27017/auth_db?authSource=admin
      JWT_SECRET: your_jwt_secret_key_here
      JWT_EXPIRE: 7d
      ISSUE_SERVICE_URL: http://issue-service:4002
      ANALYTICS_SERVICE_URL: http://analytics-service:4003
      GOOGLE_OAUTH_CLIENT_ID: ${GOOGLE_OAUTH_CLIENT_ID}
      GITHUB_OAUTH_CLIENT_ID: ${GITHUB_OAUTH_CLIENT_ID}
    depends_on:
      mongodb:
        condition: service_healthy
    networks:
      - gamification_network
    healthcheck:
      test: curl --fail http://localhost:4001/health || exit 1
      interval: 30s
      timeout: 10s
      retries: 3

  # Issue Management Service (Issues, Comments, Alerts)
  issue-service:
    build:
      context: ./Web_Backend/issue-service
      dockerfile: Dockerfile
    container_name: issue_service
    ports:
      - "4002:4002"
    environment:
      NODE_ENV: development
      PORT: 4002
      MONGODB_URI: mongodb://admin:mongodb_password@mongodb:27017/issue_db?authSource=admin
      GRAPHQL_PORT: 4002
      AUTH_SERVICE_URL: http://auth-service:4001
      ANALYTICS_SERVICE_URL: http://analytics-service:4003
    depends_on:
      mongodb:
        condition: service_healthy
    networks:
      - gamification_network
    healthcheck:
      test: curl --fail http://localhost:4002/health || exit 1
      interval: 30s
      timeout: 10s
      retries: 3

  # Analytics & AI Service (Chatbot, Classification, Trends)
  analytics-service:
    build:
      context: ./Web_Backend/ai-service
      dockerfile: Dockerfile
    container_name: analytics_service
    ports:
      - "4003:4003"
    environment:
      NODE_ENV: development
      PORT: 4003
      MONGODB_URI: mongodb://admin:mongodb_password@mongodb:27017/analytics_db?authSource=admin
      GEMINI_API_KEY: ${GEMINI_API_KEY}
      AUTH_SERVICE_URL: http://auth-service:4001
      ISSUE_SERVICE_URL: http://issue-service:4002
    depends_on:
      mongodb:
        condition: service_healthy
    networks:
      - gamification_network
    healthcheck:
      test: curl --fail http://localhost:4003/health || exit 1
      interval: 30s
      timeout: 10s
      retries: 3



  # Authentication Frontend
  auth-frontend:
    build:
      context: ./Web_Frontend/auth_frontend
      dockerfile: Dockerfile
    container_name: auth_frontend
    ports:
      - "3001:5173"
    environment:
      VITE_API_URL: http://localhost:4001
      VITE_AUTH_SERVICE: http://localhost:4001
      VITE_ISSUE_SERVICE: http://localhost:4002
      VITE_ANALYTICS_SERVICE: http://localhost:4003
    depends_on:
      - auth-service
      - issue-service
    networks:
      - gamification_network

  # Analytics Frontend
  analytics-frontend:
    build:
      context: ./Web_Frontend/analytics_frontend
      dockerfile: Dockerfile
    container_name: analytics_frontend
    ports:
      - "3002:5173"
    environment:
      VITE_API_URL: http://localhost:4003
      VITE_GRAPHQL_ENDPOINT: http://localhost:4003/graphql
    depends_on:
      - analytics-service
    networks:
      - gamification_network

  # Issue Tracking Frontend
  issue-frontend:
    build:
      context: ./Web_Frontend/issue_frontend
      dockerfile: Dockerfile
    container_name: issue_frontend
    ports:
      - "3003:5173"
    environment:
      VITE_API_URL: http://localhost:4002
      VITE_GRAPHQL_ENDPOINT: http://localhost:4002/graphql
    depends_on:
      - issue-service
    networks:
      - gamification_network

  # API Gateway / Reverse Proxy (Optional - for easier service discovery)
  # nginx:
  #   image: nginx:alpine
  #   container_name: api_gateway
  #   ports:
  #     - "80:80"
  #     - "443:443"
  #   volumes:
  #     - ./nginx.conf:/etc/nginx/nginx.conf:ro
  #     - ./ssl:/etc/nginx/ssl:ro
  #   depends_on:
  #     - auth-service
  #     - issue-service
  #     - analytics-service
  #   networks:
  #     - gamification_network
  #   healthcheck:
  #     test: curl --fail http://localhost/health || exit 1
  #     interval: 30s
  #     timeout: 10s
  #     retries: 3

volumes:
  mongo_data:
    driver: local
  mongo_config:
    driver: local

networks:
  gamification_network:
    driver: bridge
